

---

# `crates/ron-proto/` — file tree (final)

```
crates/
└─ ron-proto/
   ├─ Cargo.toml
   ├─ README.md
   ├─ CHANGELOG.md
   ├─ LICENSE-APACHE
   ├─ LICENSE-MIT
   ├─ src/
   │  ├─ lib.rs
   │  ├─ id/
   │  │  ├─ mod.rs
   │  │  ├─ content_id.rs
   │  │  └─ parse.rs
   │  ├─ oap/
   │  │  ├─ mod.rs
   │  │  ├─ hello.rs
   │  │  ├─ start.rs
   │  │  ├─ data.rs
   │  │  ├─ end.rs
   │  │  └─ error.rs
   │  ├─ manifest/
   │  │  ├─ mod.rs
   │  │  ├─ v1.rs
   │  │  └─ common.rs
   │  ├─ mailbox/
   │  │  ├─ mod.rs
   │  │  ├─ send.rs
   │  │  ├─ recv.rs
   │  │  └─ ack.rs
   │  ├─ cap/
   │  │  ├─ mod.rs
   │  │  ├─ header.rs
   │  │  └─ caveats.rs
   │  ├─ error/
   │  │  ├─ mod.rs
   │  │  ├─ kind.rs
   │  │  └─ reason.rs
   │  ├─ version.rs
   │  ├─ trace.rs
   │  ├─ naming.rs
   │  ├─ econ/
   │  │  ├─ mod.rs
   │  │  └─ move_entry.rs
   │  ├─ gov/
   │  │  ├─ mod.rs
   │  │  └─ signed_descriptor.rs
   │  └─ quantum/
   │     ├─ mod.rs
   │     └─ pq_tags.rs
   ├─ tests/
   │  ├─ interop_parity.rs
   │  ├─ cross_version.rs
   │  ├─ hash_truth.rs
   │  ├─ econ_conservation.rs
   │  ├─ fuzz/
   │  │  └─ corpora/
   │  │     ├─ decode_oap_header/
   │  │     ├─ decode_manifest/
   │  │     ├─ parse_contentid/
   │  │     └─ decode_capability/
   │  └─ vectors/
   │     ├─ oap_hello_v1.json
   │     ├─ oap_error_envelope.json
   │     ├─ manifest_v1.json
   │     └─ content_id.json
   ├─ benches/
   │  ├─ encode_decode_small.rs
   │  └─ encode_decode_large.rs
   ├─ fuzz/
   │  ├─ Cargo.toml
   │  └─ fuzz_targets/
   │     ├─ decode_oap_header.rs
   │     ├─ decode_manifest.rs
   │     ├─ parse_contentid.rs
   │     └─ decode_capability.rs
   ├─ docs/
   │  ├─ ALL_DOCS.md
   │  ├─ API.md
   │  ├─ CONFIG.md
   │  ├─ OBSERVABILITY.md
   │  ├─ PERFORMANCE.md
   │  ├─ QUANTUM.md
   │  ├─ RUNBOOK.md
   │  ├─ SECURITY.md
   │  ├─ TESTS.md
   │  ├─ arch.mmd
   │  ├─ sequence.mmd
   │  ├─ state.mmd
   │  ├─ api-history/
   │  │  └─ ron-proto/
   │  │     └─ <auto-generated>.txt
   │  └─ schema/
   │     ├─ README.md
   │     └─ json/
   │        ├─ oap_hello.schema.json
   │        └─ manifest_v1.schema.json
   ├─ testing/
   │  └─ performance/
   │     └─ baselines/
   │        └─ ron-proto.json
   └─ .github/
      └─ workflows/
         ├─ ci.yml
         ├─ fuzz.yml
         └─ render-mermaid.yml
```

---

## What each file/dir does (concise roles)

### Top-level

* **Cargo.toml** — Pure library crate metadata, feature flags (`cbor`, `schemars`), strict dep pins. Zero I/O/crypto deps.
* **README.md** — Canon overview + invariants + acceptance gates; diagrams policy; test/bench commands.
* **CHANGELOG.md** — SemVer ledger; required for any public API change.
* **LICENSE-APACHE / LICENSE-MIT** — Dual-license texts.

### `src/` (DTO-only surface, tiny files)

* **lib.rs** — Flat re-export facade of the public API; the only module users import.

#### IDs

* **id/mod.rs** — Public entry for IDs; unit tests for round-trips here.
* **id/content_id.rs** — `ContentId` newtype; serde rules; display/parse traits.
* **id/parse.rs** — Parsing helpers & typed parse errors (no hashing here).

#### OAP/1 envelopes

* **oap/mod.rs** — Public entry for OAP frames; common types/constants.
* **oap/hello.rs** — `Hello` DTO (version/features); strict serde.
* **oap/start.rs** — `Start` DTO (session/params).
* **oap/data.rs** — `Data` DTO (object id, chunk_no, bytes); doc the 1 MiB frame cap.
* **oap/end.rs** — `End` DTO (status/finalization).
* **oap/error.rs** — `Error` DTO (code/message/details).

#### Manifests

* **manifest/mod.rs** — Versioned manifest entry; shared types.
* **manifest/v1.rs** — `ManifestV1` DTO; additive growth policy.
* **manifest/common.rs** — Enums/consts shared across versions.

#### Mailbox

* **mailbox/mod.rs** — Entry for mailbox DTOs.
* **mailbox/send.rs** — `Send` DTO with idempotency headers.
* **mailbox/recv.rs** — `Recv` DTO.
* **mailbox/ack.rs** — `Ack` DTO.

#### Capability headers

* **cap/mod.rs** — Entry for capability header shapes.
* **cap/header.rs** — `CapTokenHdr` (typed claims; no verification here).
* **cap/caveats.rs** — Enumerated caveats/flags (non-exhaustive for additive growth).

#### Errors & taxonomy

* **error/mod.rs** — Error envelope.
* **error/kind.rs** — `ProtoErrorKind` variants (stable).
* **error/reason.rs** — “Reason canon”: stable string reasons for metrics/logs (no metrics deps).

#### Misc core

* **version.rs** — `PROTO_VERSION` and `PROTO_ABI_FINGERPRINT` constants for ABI auditing.
* **trace.rs** — `trace_fields()` helper returning stable span fields (no tracing dep).
* **naming.rs** — Types for names/refs (resolution lives in services).

#### Economics

* **econ/mod.rs** — ECON DTO namespace.
* **econ/move_entry.rs** — `MoveEntry` debit/credit record; enables conservation proofs (logic elsewhere).

#### Governance (new)

* **gov/mod.rs** — Governance/registry DTO namespace (policy stays out).
* **gov/signed_descriptor.rs** — Descriptor DTOs that may be signed by services; only schema here.

#### Quantum/PQ (new)

* **quantum/mod.rs** — PQ-hybrid tags namespace; no crypto.
* **quantum/pq_tags.rs** — Algorithm/param enums (e.g., Kyber variants) with deterministic serde.

### `tests/` (interop & property proofs)

* **interop_parity.rs** — Vector parity tests (JSON/DAG-CBOR), byte-identical round-trips.
* **cross_version.rs** — N↔N±1 decode behavior; strict unknown-field rejections.
* **hash_truth.rs** — Sanity: BLAKE3 digest matches the `ContentId` in vectors (consumer responsibility, verified in tests).
* **econ_conservation.rs** — Property tests for `MoveEntry` encodings (no negatives/double-spends).
* **fuzz/corpora/** — **Preserved** minimized seeds/crashers for each fuzz target (prevents regressions).
* **vectors/** — Canonical interop vectors shared with SDKs (do not hand-edit casually).

### `benches/` (perf guardrails)

* **encode_decode_small.rs** — Micro-bench for small DTOs (≤1 KiB).
* **encode_decode_large.rs** — Stress bench for large frames/manifests (~1 MiB); feeds perf baseline.

### `fuzz/` (named targets, libFuzzer/AFL-compatible)

* **Cargo.toml** — Fuzz project manifest (separate from main crate).
* **fuzz_targets/decode_oap_header.rs** — Structure-aware fuzz for OAP headers.
* **fuzz_targets/decode_manifest.rs** — Fuzz manifests (versioned).
* **fuzz_targets/parse_contentid.rs** — Fuzz the `ContentId` parser/format.
* **fuzz_targets/decode_capability.rs** — Fuzz cap header decoding.

### `docs/` (living spec + diagrams)

* **ALL_DOCS.md** — Combined docs package (your attachment) near code.
* **API.md, CONFIG.md, OBSERVABILITY.md, PERFORMANCE.md, QUANTUM.md, RUNBOOK.md, SECURITY.md, TESTS.md** — Split references for contributors, operators, and auditors.
* **arch.mmd / sequence.mmd / state.mmd** — Mermaid sources rendered in CI (kept in lockstep with code).
* **api-history/ron-proto/<auto-generated>.txt** — `cargo public-api` snapshots for SemVer enforcement.
* **schema/README.md** — How TS/Py/Swift codegen should consume `*.schema.json` and parity-test them.
* **schema/json/*.schema.json** — Optional `schemars` outputs for downstream tooling & schema-diff CI.

### `testing/performance/baselines/ron-proto.json`

* Perf baseline (size-binned) used by CI to gate regressions (e.g., ≤10% slower or bigger).

### `.github/workflows/` (CI gates)

* **ci.yml** — Build, fmt, clippy, tests, **miri** pass, public-api diff, schema diff (if enabled), perf baseline compare, `cargo deny`.
* **fuzz.yml** — Long-run nightly fuzz (≥4h) with corpora persistence; short per-PR smoke (≥1h).
* **render-mermaid.yml** — Renders `.mmd` → SVG artifacts to keep diagrams current.

---

## DX notes (keep it smooth)

* Keep files **tiny**; if any submodule stays <~200 LoC post-impl, feel free to in-line 1–2 of them into its `mod.rs` to reduce jumpiness—but preserve the **flat re-exports** in `lib.rs`.
* Strict `#[serde(deny_unknown_fields)]` on external DTOs; reserve fields for additive growth; `#[non_exhaustive]` on enums that will evolve.
* Never add I/O/crypto/transports here—**types only**.

