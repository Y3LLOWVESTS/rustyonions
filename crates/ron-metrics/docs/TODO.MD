
---

# ğŸ“ File Tree â€” `crates/ron-metrics`

```text
crates/
â””â”€ ron-metrics/
   â”œâ”€ Cargo.toml
   â”œâ”€ README.md
   â”œâ”€ CHANGELOG.md
   â”œâ”€ LICENSE-APACHE
   â”œâ”€ LICENSE-MIT
   â”œâ”€ CODEOWNERS
   â”œâ”€ .gitignore
   â”œâ”€ rust-toolchain.toml
   â”œâ”€ deny.toml
   â”œâ”€ .cargo/
   â”‚  â””â”€ config.toml
   â”œâ”€ src/
   â”‚  â”œâ”€ lib.rs
   â”‚  â”œâ”€ config.rs
   â”‚  â”œâ”€ metrics.rs
   â”‚  â”œâ”€ registry.rs
   â”‚  â”œâ”€ labels.rs
   â”‚  â”œâ”€ readiness.rs
   â”‚  â”œâ”€ health.rs
   â”‚  â”œâ”€ errors.rs
   â”‚  â”œâ”€ build_info.rs
   â”‚  â”œâ”€ pq.rs
   â”‚  â”œâ”€ zk.rs
   â”‚  â””â”€ exposer/
   â”‚     â”œâ”€ mod.rs
   â”‚     â”œâ”€ http.rs
   â”‚     â”œâ”€ middleware.rs
   â”‚     â”œâ”€ uds.rs
   â”‚     â””â”€ tls.rs
   â”œâ”€ exporters/
   â”‚  â”œâ”€ mod.rs
   â”‚  â””â”€ otel.rs
   â”œâ”€ examples/
   â”‚  â””â”€ exposer.rs
   â”œâ”€ tests/
   â”‚  â”œâ”€ integration_http_endpoints.rs
   â”‚  â”œâ”€ taxonomy_labels.rs
   â”‚  â”œâ”€ readiness_semantics.rs
   â”‚  â”œâ”€ public_api.rs
   â”‚  â”œâ”€ loom_shutdown.rs
   â”‚  â””â”€ vectors/
   â”‚     â””â”€ interop/ron-metrics/
   â”‚        â”œâ”€ readyz-ready.json
   â”‚        â”œâ”€ readyz-degraded.json
   â”‚        â”œâ”€ metrics-small.prom
   â”‚        â””â”€ metrics-large.prom
   â”œâ”€ benches/
   â”‚  â”œâ”€ exposer_bench.rs
   â”‚  â””â”€ hotpath_bench.rs
   â”œâ”€ docs/
   â”‚  â”œâ”€ API.md
   â”‚  â”œâ”€ CONCURRENCY.md
   â”‚  â”œâ”€ CONFIG.md
   â”‚  â”œâ”€ GOVERNANCE.md
   â”‚  â”œâ”€ IDB.md
   â”‚  â”œâ”€ INTEROP.md
   â”‚  â”œâ”€ OBSERVABILITY.md
   â”‚  â”œâ”€ PERFORMANCE.md
   â”‚  â”œâ”€ QUANTUM.md
   â”‚  â”œâ”€ RUNBOOK.md
   â”‚  â”œâ”€ SECURITY.md
   â”‚  â”œâ”€ mmd/
   â”‚  â”‚  â”œâ”€ arch.mmd
   â”‚  â”‚  â”œâ”€ sequence.mmd
   â”‚  â”‚  â””â”€ state.mmd
   â”‚  â”œâ”€ api-history/
   â”‚  â”‚  â””â”€ ron-metrics/
   â”‚  â”‚     â””â”€ 0001.initial.txt
   â”‚  â””â”€ sbom/
   â”‚     â””â”€ .gitkeep
   â”œâ”€ scripts/
   â”‚  â”œâ”€ check-taxonomy.sh
   â”‚  â””â”€ render-mermaid.sh
   â””â”€ .github/
      â””â”€ workflows/
         â”œâ”€ ci.yml
         â”œâ”€ coverage.yml
         â”œâ”€ public-api.yml
         â”œâ”€ mermaid.yml
         â”œâ”€ sanitizer.yml
         â””â”€ perf-smoke.yml
```

---

# ğŸ“„ Per-File Descriptions

## Repo meta & policy

* **Cargo.toml** â€” Declares the crate, features (`otel`, `tls`, `pq`, `zk`), and workspace-pinned deps; sets MSRV and categories; no code gen.
* **README.md** â€” Contract of behavior and interfaces (endpoints, labels, SLOs, acceptance gates, diagrams); single source of truth for users/operators.
* **CHANGELOG.md** â€” SemVer history and migration notes (especially metric/label changes and endpoint semantics).
* **LICENSE-APACHE / LICENSE-MIT** â€” Dual licensing files for redistribution/audit compliance.
* **CODEOWNERS** â€” Enforces review from designated maintainers for changes to public API/metrics taxonomy.
* **.gitignore** â€” Ignores build artifacts, coverage, bench outputs, SBOMs, and rendered diagrams.
* **rust-toolchain.toml** â€” Pins the Rust toolchain to stabilize CI and local dev parity.
* **deny.toml** â€” `cargo-deny` policy for licenses/advisories/banned crates; keeps the supply chain clean.

## Cargo config

* **.cargo/config.toml** â€” Common build flags and lints; treats warnings as errors in CI and can set default run profiles.

## Library source

* **src/lib.rs** â€” Minimal faÃ§ade that re-exports public items (`Metrics`, `Config`, readiness DTOs) and wires crate-level docs; no heavy logic.
* **src/config.rs** â€” Typed configuration loader/validator (TCP addr vs UDS path, timeouts, TLS file paths, OTLP endpoint); rejects unsafe combos early.
* **src/metrics.rs** â€” Owns metric family registration (golden counters/histograms/gauges) and provides handles used by the exposer; ensures one-time registry init.
* **src/registry.rs** â€” Helpers around `prometheus::Registry` to prevent duplicate registration and to namespace families consistently.
* **src/labels.rs** â€” Defines and validates base labels (`service`, `instance`, `build_version`, `amnesia`) and enforces low-cardinality rules.
* **src/readiness.rs** â€” Readiness JSON DTO and evaluation logic; encodes **fail-open reads / fail-closed writes** policy with `Retry-After` guidance.
* **src/health.rs** â€” Liveness snapshot glue (simple yes/no) separate from readiness; avoids coupling basic up/down to dependency state.
* **src/errors.rs** â€” Small, ops-focused error taxonomy (Busy/Timeout/Canceled/Lagging) used across endpoints and middleware.
* **src/build_info.rs** â€” Injects build metadata (version/commit/date) from env to populate the `build_version` label deterministically.
* **src/pq.rs** â€” Declares PQ-related metric families (e.g., `pq_kex_failures_total`) so dashboards remain stable even when PQ is inactive.
* **src/zk.rs** â€” Declares ZK metric families (e.g., verify failures/latencies) with predefined buckets; present as zeroes when ZK is unused.

### HTTP exposer (isolated)

* **src/exposer/mod.rs** â€” Assembles the Axum router for `GET /metrics`, `GET /healthz`, `GET /readyz`; mounts middleware and wiring to `Metrics`.
* **src/exposer/http.rs** â€” Handlers and method guards (GET-only), response headers (`no-store`, `nosniff`), and content shaping; keeps path logic tiny.
* **src/exposer/middleware.rs** â€” Per-route timeouts/concurrency caps and inflight gauges; keeps `/metrics` responsive under load.
* **src/exposer/uds.rs** â€” UDS binding with secure mode defaults (0700 dir / 0600 socket) and safety checks (no symlinks).
* **src/exposer/tls.rs** â€” TLS wiring specifically using `tokio_rustls::rustls::ServerConfig`; isolates certificate loading and acceptor creation.

## Exporters (optional)

* **exporters/mod.rs** â€” Feature-gate seam for exporters; keeps core API unchanged regardless of enabled exporters.
* **exporters/otel.rs** â€” OTLP exporter mapping (1:1 with Prometheus families/labels) when `otel` feature is enabled.

## Examples

* **examples/exposer.rs** â€” Minimal, doc-tested example showing `Metrics::new().serve(...)` and printing the bound address; used for quick local checks.

## Tests (acceptance gates)

* **tests/integration_http_endpoints.rs** â€” Verifies `/metrics`, `/healthz`, `/readyz` status codes, headers, and body shapes end-to-end.
* **tests/taxonomy_labels.rs** â€” Enforces suffix discipline (`*_seconds|*_bytes|*_total`) and presence of base labels on all first-party families.
* **tests/readiness_semantics.rs** â€” Asserts **fail-open reads / fail-closed writes**, including `Retry-After` on 503 and degraded/missing keys behavior.
* **tests/public_api.rs** â€” Guards against public symbol drift (compares to stored snapshot) to maintain SemVer stability.
* **tests/loom_shutdown.rs** â€” Loom-gated test that supervises shutdown paths and ensures no lock is held across `.await` in critical sections.
* **tests/vectors/interop/ron-metrics/readyz-ready.json** â€” Canonical sample for a healthy readiness response used by tests and external SDKs.
* **tests/vectors/interop/ron-metrics/readyz-degraded.json** â€” Canonical degraded example with `missing` keys and `retry_after` used by tests.
* **tests/vectors/interop/ron-metrics/metrics-small.prom** â€” Small, deterministic Prometheus output used for taxonomy and parser tests.
* **tests/vectors/interop/ron-metrics/metrics-large.prom** â€” Large registry variant to test scraper performance and size limits.

## Benches (SLO proof)

* **benches/exposer_bench.rs** â€” Criterion benchmarks for `/metrics` exposition latency across registry sizes; backs the p95 SLO gate.
* **benches/hotpath_bench.rs** â€” Measures counter/histogram update hot path for allocation/lock behavior to prevent regressions.

## Docs (living design)

* **docs/API.md** â€” Public Rust surface and stability rules; documents expected signatures and invariants for `Metrics`/exposer.
* **docs/CONCURRENCY.md** â€” States runtime rules (no locks across `.await`), threading, and loom strategy for safety.
* **docs/CONFIG.md** â€” Enumerates env/flags schema; defines TCP vs UDS vs TLS modes and safe defaults.
* **docs/GOVERNANCE.md** â€” Review process and ownership; clarifies how metric/label changes are approved and versioned.
* **docs/IDB.md** â€” Invariant-Driven Blueprint: MUSTs, Principles, and PROOF gates that the tests/CI enforce.
* **docs/INTEROP.md** â€” Readiness JSON schema, Prometheus exposition rules, and OTLP mapping; includes canonical vectors.
* **docs/OBSERVABILITY.md** â€” Golden metrics, base labels, dashboards, and alerting best practices tied to this crate.
* **docs/PERFORMANCE.md** â€” SLO targets, reproduction methods, and perf regression policy for merges.
* **docs/QUANTUM.md** â€” PQ posture (observability scope) and how PQ metrics are represented without forcing PQ adoption.
* **docs/RUNBOOK.md** â€” Operator procedures, common incidents, and diagnostic steps for unhealthy scrapes or readiness 503s.
* **docs/SECURITY.md** â€” Threat model, GET-only stance, TLS type invariant, and label cardinality guardrails.
* **docs/mmd/arch.mmd** â€” Mermaid flowchart of the exposer with Prometheus/OTLP; rendered in CI for visual audit.
* **docs/mmd/sequence.mmd** â€” Mermaid sequence diagram of a scrape, deadlines, and success path.
* **docs/mmd/state.mmd** â€” Mermaid state diagram for lifecycle: Idle â†’ Running â†’ Degraded â†’ Shutdown.
* **docs/api-history/ron-metrics/0001.initial.txt** â€” Baseline `cargo public-api` snapshot to detect breaking changes in CI.
* **docs/sbom/.gitkeep** â€” Placeholder to store generated SBOMs (CycloneDX) for releases.

## Scripts

* **scripts/check-taxonomy.sh** â€” CI helper script that asserts suffix discipline and base labels in `/metrics` output.
* **scripts/render-mermaid.sh** â€” Local helper that renders all `.mmd` files to `.svg` to preview diagrams offline.

## GitHub Actions

* **.github/workflows/ci.yml** â€” Main CI: fmt, clippy (deny warnings), tests, and `cargo-deny`; fast feedback on every PR.
* **.github/workflows/coverage.yml** â€” Enforces â‰¥80% branches on core modules via `cargo llvm-cov`; blocks regressions.
* **.github/workflows/public-api.yml** â€” Fails on public symbol diffs using `cargo public-api`; keeps SemVer honest.
* **.github/workflows/mermaid.yml** â€” Renders Mermaid diagrams to SVG artifacts so reviewers can see topology diffs.
* **.github/workflows/sanitizer.yml** â€” Optional nightly TSan run to catch data races in the exposer/middleware.
* **.github/workflows/perf-smoke.yml** â€” Non-blocking smoke that hammers `/metrics` and surfaces latency artifacts for manual review.

---

