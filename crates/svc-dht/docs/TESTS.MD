**File:** `crates/svc-dht/TESTS.md`

````markdown
# üß™ TESTS.md ‚Äî svc-dht

*Audience: developers, auditors, CI maintainers*  
*msrv: 1.80.0 (Tokio/loom compatible)*

---

## 0) Purpose

Define the **test contract** for `svc-dht`:

- Unit, integration, property, fuzz, chaos/soak, and performance tests.
- Explicit coverage goals & Bronze‚ÜíSilver‚ÜíGold acceptance gates.
- Copy-pasteable invocation for devs & CI.

`svc-dht` is a Kademlia/Discv5 discovery service. Test focus: **routing-table correctness**, **lookup/provide semantics**, **resilience under churn/partition**, **observability**, and **no panics** on hostile inputs.

---

## 1) Test Taxonomy

### 1.1 Unit Tests

**Scope:** Pure logic; fast (<100ms).  
**Targets:**
- `routing::kbucket` ‚Äî insert/evict/refresh; LRU discipline; ‚Äúsingle-writer per k-bucket‚Äù respected.
- `routing::distance` ‚Äî XOR distance invariants (symmetry; `d(a,a)=0`; deterministic ordering).
- `lookup::planner` ‚Äî Œ±/Œ≤ hedging planner caps inflight; timeout budget obeyed.
- `policy::limits` ‚Äî per-peer ceilings; quota buckets.
- `codec::{msg,peerid}` ‚Äî encode/decode simple frames; no allocations > limits.

**Location:** `src/**` with `#[cfg(test)]`.  
**Run:**
```bash
cargo test -p svc-dht --lib
````

### 1.2 Integration Tests

**Scope:** End-to-end crate surface in `tests/*.rs`.
**Must include:**

* **Bootstrap & Readiness:** start ephemeral svc-dht with 1‚Äì3 static bootstraps ‚Üí `/readyz` within SLA; routing table warmed.
* **API Round-Trip:** `PROVIDE(key)` then `GET_PROVIDERS(key)` returns self (with eventual consistency budget).
* **Config Reload:** send SIGHUP or hot-reload endpoint ‚Üí Œ±/Œ≤/timeouts reflect new config without dropping existing sessions. „ÄêCONFIG.md„Äë
* **Concurrency Invariants:** clean shutdown on SIGINT; no tasks left running; backpressure holds under bus lag. „ÄêCONCURRENCY.md„Äë
* **Reject Paths:** structured 400/404/413/429/503; no secret leakage; `Retry-After` where applicable. „ÄêSECURITY.md/OBSERVABILITY.md„Äë

**Run:**

```bash
cargo test -p svc-dht --test '*'
```

### 1.3 Property-Based Tests

**Scope:** Parsers, codecs, routing policies, state-machine transitions.
**Tooling:** `proptest` (preferred) or `quickcheck`.

**Invariants (examples):**

* **Codec round-trip:** `decode(encode(msg)) == msg` for DHT messages within size limits.
* **Idempotent PROVIDE:** repeating `PROVIDE(k)` for same peer does not multiply entries.
* **Routing placement:** for random `PeerId`, bucket index matches prefix; distance ordering consistent for any (a,b,c): `d(a,b) < d(a,c)` ‚áí `rank(a,b) < rank(a,c)`.
* **No panics / no UB:** fuzzer-generated byte streams fed to decoders never panic.

**Run:**

```bash
cargo test -p svc-dht --features proptest
```

### 1.4 Fuzz Tests

**Scope:** Wire-facing surfaces.

* `fuzz_targets/msg_decode.rs` ‚Äî DHT message decoder (varint/length-prefix; bounds-checked).
* `fuzz_targets/oap_frame.rs` ‚Äî OAP/1 frame parser (max-frame, chunk sizing).
* `fuzz_targets/admin_json.rs` ‚Äî admin/metrics JSON handlers (robust redaction; no panics).

**Tooling:** `cargo fuzz` (llvm-libfuzzer).
**Corpus:** seeded from CI failures + sanitized pcaps + property seeds.

**Acceptance:**

* CI quick smoke: 60s per target, **zero crashes/oom**.
* Nightly: **‚â•4h** per target, **zero crashes**; new findings become regression seeds.

**Run:**

```bash
cargo fuzz run msg_decode -- -max_total_time=60
cargo fuzz run oap_frame  -- -max_total_time=60
```

### 1.5 Chaos / Soak Tests

**Scope:** Service behavior under faults & time.

* **Process crashes:** random worker kill ‚Üí supervisor restart; `/readyz` restores ‚â§10s p99.
* **Network faults:** 50% loss / +300ms latency on bootstraps; partition one replica.
* **Bus stress:** delayed/dropped events; must not deadlock.
* **Resource pressure:** FD exhaustion attempt; memory pressure (should shed, not crash).

**Acceptance:** **24h soak** = zero FD leaks (steady descriptors), memory stable (no unbounded growth), no deadlocks; alerting fired appropriately.

**Harness (examples):**

```bash
# loss/latency (fallback if no ronctl chaos)
tc qdisc add dev <iface> root netem loss 50%
tc qdisc change dev <iface> root netem delay 300ms
tc qdisc del dev <iface> root netem
```

### 1.6 Performance / Load Tests

**Scope:** Throughput, latency, hop budget, quotas.

* **Emulated swarm:** N peers with configurable churn; measure **p95 lookup < 500ms** (intra-AZ), **hop p99 ‚â§ 5** under nominal churn (<10%/h).
* **Hedging efficacy:** Œ≤=0/1/2/3 comparisons; ensure reduced tail without overload.
* **Quota behavior:** sustained RPS hits per-peer ceilings with correct 429 rate.

**Tools:** `criterion` micro-benches for hot paths; `testing/load_harness` for swarm.
**Run:**

```bash
cargo bench -p svc-dht
cargo run -p testing-load -- --replicas 1 --peers 2000 --rps 500
```

---

## 2) Coverage & Gates

### 2.1 Bronze (MVP)

* Unit + integration tests pass locally and in CI.
* Line **and** branch coverage ‚â• **70%** (excluding generated code).
* Fuzz harness builds for all targets; 60s smoke passes.

### 2.2 Silver (Useful Substrate)

* Property tests included for codec/routing.
* Fuzz run ‚â• **1h** per target in CI nightly.
* Coverage ‚â• **85%**; no **unsafe** (if present) without tests covering the boundary.
* Basic chaos scripts checked into `testing/chaos/` and exercised weekly.

### 2.3 Gold (Ops-Ready)

* Fuzz run ‚â• **4h** nightly; zero new crashes for 14 consecutive days.
* **24h** soak job green (no FD/memory leaks; no deadlocks).
* Coverage ‚â• **90%**; mutation score (if enabled) ‚â• **70%**.
* Perf CI tracks regression per release; fail if p95 intra-AZ > **500ms** or hop p99 > **5**.

---

## 3) Invocation Examples

### 3.1 All tests (crate)

```bash
cargo test -p svc-dht --all-targets -- --nocapture
```

### 3.2 Specific integration test

```bash
cargo test -p svc-dht --test bootstrap_ready -- --nocapture
```

### 3.3 Fuzz targets (quick smoke)

```bash
cargo fuzz run msg_decode -- -max_total_time=60
cargo fuzz run oap_frame  -- -max_total_time=60
cargo fuzz run admin_json -- -max_total_time=60
```

### 3.4 Loom (concurrency model)

> Ensures no deadlocks and enforces single-writer per k-bucket.

```bash
RUSTFLAGS="--cfg loom" cargo test -p svc-dht --test loom_*
```

### 3.5 Benchmarks

```bash
cargo bench -p svc-dht
```

---

## 4) Observability Hooks

* Tests emit **structured JSON** on failure; logs include `corr_id`, `peer_id`, `hops`, `reason`.
* Exemplars: latency samples attached to Prometheus histograms in perf tests.
* Test harness propagates `corr_id` into sub-services so cross-crate traces can be reconstructed.
* Redaction rules enforced in negative-path tests (no secrets/PII in logs).

---

## 5) CI Enforcement

**Recommended GitHub Actions steps (workspace-aware):**

```bash
cargo fmt --all -- --check
cargo clippy --workspace --all-targets -- -D warnings
cargo test  --workspace --all-targets -- --nocapture
cargo deny check advisories
# optional if enabled:
cargo install cargo-tarpaulin || true
cargo tarpaulin --out Xml --workspace --timeout 600
# nightly jobs:
cargo fuzz run msg_decode -- -max_total_time=3600
cargo fuzz run oap_frame  -- -max_total_time=3600
cargo fuzz run admin_json -- -max_total_time=3600
```

**Matrix:** run on `x86_64-unknown-linux-gnu` and `aarch64-unknown-linux-gnu` (release builds) to satisfy portability gates.

---

## 6) Open Questions (crate-specific to finalize)

* **Loom invariants:** exact set beyond single-writer buckets (e.g., no `.await` while holding locks; bounded inflight under bus lag).
* **Mandatory fuzz targets:** confirm list (msg_decode, oap_frame, admin_json) and any transport-layer fuzz surfaces.
* **Perf SLOs:** inter-region budgets & hedging profiles for multi-AZ; finalize RPS target per replica for CI load job.

---

## Appendix A ‚Äî Suggested test files layout

```
svc-dht/
  src/
    routing/...
    codec/...
  tests/
    bootstrap_ready.rs
    provide_getproviders.rs
    config_reload.rs
    rejects_structured.rs
    loom_shutdown_backpressure.rs   # behind --cfg loom
  fuzz/
    fuzz_targets/
      msg_decode.rs
      oap_frame.rs
      admin_json.rs
  testing/
    chaos/
      netem.sh
      partition.sh
    load_harness/
      Cargo.toml
      src/main.rs
```

‚úÖ This contract makes `svc-dht` verifiably safe, resilient, and performant, and prevents silent drift of test discipline over time.

```
```
