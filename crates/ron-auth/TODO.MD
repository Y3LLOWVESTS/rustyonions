
---

# ğŸ“¦ `crates/ron-auth/` â€” Full Scaffold (no code)

```
crates/ron-auth/
â”œâ”€ Cargo.toml
â”œâ”€ README.md
â”œâ”€ CHANGELOG.md
â”œâ”€ LICENSE-APACHE
â”œâ”€ LICENSE-MIT
â”œâ”€ .gitignore
â”œâ”€ .editorconfig
â”œâ”€ rustfmt.toml
â”œâ”€ deny.toml
â”œâ”€ CODEOWNERS
â”œâ”€ CONTRIBUTING.md
â”œâ”€ .github/
â”‚  â””â”€ workflows/
â”‚     â”œâ”€ ci.yml
â”‚     â””â”€ pq-matrix.yml
â”œâ”€ docs/
â”‚  â”œâ”€ ALL_DOCS.md
â”‚  â”œâ”€ README.md
â”‚  â”œâ”€ IDB.md
â”‚  â”œâ”€ API.md
â”‚  â”œâ”€ CONFIG.md
â”‚  â”œâ”€ INTEROP.md
â”‚  â”œâ”€ OBSERVABILITY.md
â”‚  â”œâ”€ PERFORMANCE.md
â”‚  â”œâ”€ QUANTUM.md
â”‚  â”œâ”€ SECURITY.md
â”‚  â”œâ”€ RUNBOOK.md
â”‚  â””â”€ diagrams/
â”‚     â”œâ”€ arch.mmd
â”‚     â”œâ”€ sequence.mmd
â”‚     â””â”€ state.mmd
â”œâ”€ src/
â”‚  â”œâ”€ lib.rs
â”‚  â”œâ”€ prelude.rs
â”‚  â”œâ”€ capability/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ scope.rs
â”‚  â”‚  â”œâ”€ caveat.rs
â”‚  â”‚  â””â”€ encode.rs
â”‚  â”œâ”€ verify/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ decision.rs
â”‚  â”‚  â”œâ”€ error.rs
â”‚  â”‚  â””â”€ pipeline.rs
â”‚  â”œâ”€ caveats/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ builtin.rs
â”‚  â”‚  â”œâ”€ registry.rs
â”‚  â”‚  â””â”€ custom.rs
â”‚  â”œâ”€ config/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ verifier_config.rs
â”‚  â”‚  â””â”€ env.rs
â”‚  â”œâ”€ keys/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ traits.rs
â”‚  â”‚  â””â”€ mac_handle.rs
â”‚  â”œâ”€ pq/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â””â”€ sig_adapter.rs
â”‚  â”œâ”€ zk/
â”‚  â”‚  â””â”€ mod.rs
â”‚  â”œâ”€ ctx.rs
â”‚  â”œâ”€ metrics.rs
â”‚  â””â”€ redact.rs
â”œâ”€ tests/
â”‚  â”œâ”€ allow_deny_vectors.rs
â”‚  â”œâ”€ attenuation_monotonicity.rs
â”‚  â”œâ”€ parser_fixtures.rs
â”‚  â”œâ”€ compat_public_api.rs
â”‚  â”œâ”€ amnesia_mode.rs
â”‚  â””â”€ loom_verify.rs
â”œâ”€ benches/
â”‚  â””â”€ verify_bench.rs
â”œâ”€ fuzz/
â”‚  â””â”€ fuzz_targets/
â”‚     â””â”€ token_parser_fuzz.rs
â””â”€ testing/
   â”œâ”€ vectors/
   â”‚  â””â”€ ron-auth/
   â”‚     â””â”€ v1/
   â”‚        â”œâ”€ allow_example.json
   â”‚        â”œâ”€ deny_expired.json
   â”‚        â”œâ”€ deny_unknown_kid.json
   â”‚        â”œâ”€ custom_ns_examples.json
   â”‚        â”œâ”€ pq_allow.json
   â”‚        â””â”€ pq_deny_mismatch.json
   â””â”€ replay/
      â”œâ”€ README.md
      â”œâ”€ python/
      â”‚  â””â”€ placeholder.txt
      â””â”€ typescript/
         â””â”€ placeholder.txt
```

---

## ğŸ“š What each file is for (roles & rationale)

### Root, policy & ownership

* **Cargo.toml** â€” Declares a *library-only* crate; sets MSRV; defines minimal deps; exposes features: `pq`, `pq-hybrid`, `pq-only`, `config-env`, `zk` (all off by default).
* **README.md** â€” The crateâ€™s public-facing spec; mirrors types/signatures; becomes rustdoc front page via `#[doc = include_str!]`.
* **CHANGELOG.md** â€” SemVer history; notes that **deny reasons** and **metric names** are API-stable.
* **LICENSE-APACHE / LICENSE-MIT** â€” Dual licensing.
* **.gitignore / .editorconfig / rustfmt.toml** â€” Hygiene & consistent formatting.
* **deny.toml** â€” Cargo-deny policy tightened for this crate: bans non-crates.io sources; forbids I/O stacks (`tokio`, `hyper`, `reqwest`) to keep it pure; license allowlist.
* **CODEOWNERS** â€” Assigns review ownership (e.g., `crates/ron-auth/** @stevanwhite`) to enforce architectural guardianship.
* **CONTRIBUTING.md** â€” Crate-scoped rules: no I/O, no `unsafe`, public surface changes require vector updates and SemVer checks.

### CI workflows

* **.github/workflows/ci.yml** â€” Runs fmt/clippy, tests, coverage goal, `cargo-deny`, public API guard (`cargo public-api` / `cargo-semver-checks`), doc link checks; builds on MSRV explicitly; enforces â€œno I/O depsâ€ for this crate.
* **.github/workflows/pq-matrix.yml** â€” Exercises feature combos (`default`, `pq`, `pq-hybrid`, `pq-only`) and replays **PQ vectors**; ensures the crate remains PQ-ready without pulling heavy crypto until needed.

### Canon docs (split from your combined source)

* **docs/ALL_DOCS.md** â€” Your provided combined reference (kept verbatim).
* **docs/README.md** â€” Mirrors root README for consistency in `/docs/`.
* **docs/IDB.md** â€” Invariants (â€œpure libâ€, â€œcapabilities onlyâ€, deterministic CBOR, fail-closed).
* **docs/API.md** â€” Public types, enums, traits, and the canonical `verify_token` signature.
* **docs/CONFIG.md** â€” Size caps, clock skew bounds, allowed caveat namespaces, env mappings.
* **docs/INTEROP.md** â€” Test vector contract; reason strings; DTO shapes.
* **docs/OBSERVABILITY.md** â€” Metric taxonomy (verify_total, denied_total{reason}, parse_error_total{kind}, duration_us, token_size_bytes) and redaction rules.
* **docs/PERFORMANCE.md** â€” SLOs (latency slope, â‰¤2 alloc/op), baseline methodology.
* **docs/QUANTUM.md** â€” PQ migration/hybrid plan; feature mapping.
* **docs/SECURITY.md** â€” Threat model, fail-closed behaviors, constant-time compares, zeroization.
* **docs/RUNBOOK.md** â€” Host-ops guidance (rotation, appeal flows, troubleshooting).
* **docs/diagrams/*.mmd** â€” Mermaid sources for arch/sequence/state.

### Library surface (small modules; no I/O)

* **src/lib.rs** â€” Re-exports the stable public surface only; crate-level docs; no hidden side effects.
* **src/prelude.rs** â€” Curated exports for ergonomic `use ron_auth::prelude::*`.

#### Capability model

* **src/capability/mod.rs** â€” Opaque `Capability` faÃ§ade; canonical form guidance.
* **src/capability/scope.rs** â€” `Scope` data model (path/method caps, limits).
* **src/capability/caveat.rs** â€” `Caveat` enum with all built-ins and `Custom{â€¦}`.
* **src/capability/encode.rs** â€” Deterministic CBOR + Base64URL helpers; bound checks; strict decoding.

#### Verification pipeline

* **src/verify/mod.rs** â€” Public entrypoint faÃ§ade: `verify_token(...) -> Result<Decision, AuthError>` definition (no implementation yet).
* **src/verify/decision.rs** â€” `Decision::{Allow,Deny}` types; reason string stability note.
* **src/verify/error.rs** â€” Parse/shape error taxonomy for non-policy failures.
* **src/verify/pipeline.rs** â€” Orchestration skeleton: decode â†’ MAC chain â†’ caveat eval â†’ decision (kept tiny when implemented later).

#### Caveat evaluation

* **src/caveats/mod.rs** â€” Trait for caveat evaluators; dispatcher contract; deny-unknowns default.
* **src/caveats/builtin.rs** â€” Handlers list for built-ins (exp/nbf/aud/method/path/ip/bytes/rate/tenant/amnesia/policy-digest).
* **src/caveats/registry.rs** â€” Read-only registry pattern; deterministic order.
* **src/caveats/custom.rs** â€” Strict, namespaced custom caveats entrypoint.

#### Configuration & context

* **src/config/mod.rs** â€” Verifier config faÃ§ade.
* **src/config/verifier_config.rs** â€” `VerifierConfig` shape (caps, skew, namespace allowlists).
* **src/config/env.rs** â€” Optional env mapping helpers (behind `config-env` feature).

#### Key custody boundary

* **src/keys/mod.rs** â€” Key module faÃ§ade.
* **src/keys/traits.rs** â€” `MacKeyProvider`/`MacHandle` trait contracts; no key storage here.
* **src/keys/mac_handle.rs** â€” Opaque MAC handle semantics; constant-time compare; zeroize guidance.

#### PQ bridge (feature-gated)

* **src/pq/mod.rs** â€” PQ feature faÃ§ade.
* **src/pq/sig_adapter.rs** â€” Hybrid signature adapter trait for cross-org delegation (e.g., Ed25519 + Dilithium2), behind features.

#### Future ZK hook (feature-gated, empty for now)

* **src/zk/mod.rs** â€” Placeholder for future ZK-adjacent caveats/proofs; gated via `zk`, keeping core lib lean.

#### Context, metrics, redaction

* **src/ctx.rs** â€” `RequestCtx` shape (time, method, path, peer, tenant, policy digest, etc.).
* **src/metrics.rs** â€” Tiny **hook trait** so hosts can emit canonical metrics without adding Prometheus deps here.
* **src/redact.rs** â€” Digest/truncate helpers for safe logging.

### Tests, benches, fuzz

* **tests/allow_deny_vectors.rs** â€” Golden vector replayer (pass/fail parity).
* **tests/attenuation_monotonicity.rs** â€” Property test: attenuation never broadens scope.
* **tests/parser_fixtures.rs** â€” Adversarial/edge parser fixtures (bounds, unknown fields).
* **tests/compat_public_api.rs** â€” Public API stability checks for SemVer guard.
* **tests/amnesia_mode.rs** â€” Asserts â€œno retained stateâ€ property; hooks for chaos drills.
* **tests/loom_verify.rs** â€” Concurrency model stub via loom (protects future refactors from shared-state bugs).
* **benches/verify_bench.rs** â€” Criterion seats for latency slope and alloc checks.
* **fuzz/fuzz_targets/token_parser_fuzz.rs** â€” Parser fuzz target (CBOR/Base64URL structures).

### Interop vectors & polyglot replay stubs

* **testing/vectors/ron-auth/v1/allow_example.json** â€” Canonical allow case with caveats.
* **â€¦/deny_expired.json** â€” Expired token deny vector.
* **â€¦/deny_unknown_kid.json** â€” Key-ID mismatch deny vector.
* **â€¦/custom_ns_examples.json** â€” Custom caveat namespace accept/deny shapes.
* **â€¦/pq_allow.json** â€” PQ-hybrid â€œallowâ€ vector (shape-only for now).
* **â€¦/pq_deny_mismatch.json** â€” PQ-hybrid mismatch â€œdenyâ€ vector.
* **testing/replay/README.md** â€” How SDKs (Rust, Python, TS) must replay vectors for parity.
* **testing/replay/python/placeholder.txt** â€” Reserved for a tiny runner later (no code yet).
* **testing/replay/typescript/placeholder.txt** â€” Same, for TS.

---

## âœ… Why this hits 10/10 against your canon

* **Pure-lib boundaries** are unmistakable (no I/O deps allowed by policy; keys via traits only).
* **Interop authority**: vectors formalize the contract; PQ vectors future-proof it.
* **Security defaults**: deterministic encoding, bounded sizes, deny-unknowns, redactionâ€”all isolated in small, auditable files.
* **Resilience & proofs**: amnesia + loom stubs make â€œno persistence / no racesâ€ a testable property.
* **PQ & ZK foresight**: feature-gated hooks exist without dragging weight into the core.
* **DX & SemVer**: stable public surface with API guards; prelude keeps host code tidy.

