# omnigate â€” default config (Beta)

[server]
bind         = "127.0.0.1:5305"
metrics_addr = "127.0.0.1:9605"
amnesia      = true

[oap]
# Keep <= 1 MiB as enforced by config validation & invariants.
max_frame_bytes    = 1048576
stream_chunk_bytes = 65536

[admission.global_quota]
# Default (sane) production-ish limits. For forcing 429s in smoke, see the
# commented dev overrides further below.
qps   = 20000
burst = 40000

[admission.ip_quota]
enabled = true
qps     = 2000
burst   = 4000
# buckets = [ { cidr="10.0.0.0/8", qps=5000, burst=10000 } ]

[admission.fair_queue]
# Hard cap. Leave roomy for prod; readiness trips use a lower threshold below.
max_inflight = 2048
# Optional interactive headroom; if omitted, computed as max_inflight/8 by code.
headroom = 256
weights = { anon = 1, auth = 5, admin = 10 }

[admission.body]
# IMPORTANT: Align with middleware guard (1 MiB) to avoid 413s before decompression budget.
# (The decompression guard also uses this as its max expanded size.)
max_content_length       = 1048576
reject_on_missing_length = true

[admission.decompression]
allow        = ["identity", "gzip"]
deny_stacked = true

[policy]
enabled     = true
bundle_path = "crates/omnigate/configs/policy.bundle.json"
fail_mode   = "deny"  # "deny" | "allow"

[readiness]
# Tune low enough for laptop smoke to trip:
# - The inflight gauge crosses this threshold under /v1/sleep load
# - Error-rate path trips if 429/503 share exceeds this %
max_inflight_threshold = 64
error_rate_429_503_pct = 1.0
window_secs            = 10
hold_for_secs          = 20

# --- Optional dev overrides for smoke tests (uncomment as needed) ---
# [admission.global_quota]
# qps   = 50
# burst = 50
#
# [admission.ip_quota]
# enabled = true
# qps     = 50
# burst   = 50
#
# [readiness]
# max_inflight_threshold = 64
# error_rate_429_503_pct = 1.0
# window_secs            = 10
# hold_for_secs          = 20
