
---

# ğŸ“¦ `crates/micronode/` â€” scaffold (PQ-ready + chaos/fuzz + specs)

```
crates/micronode/
â”œâ”€ Cargo.toml
â”œâ”€ README.md
â”œâ”€ LICENSE-APACHE
â”œâ”€ LICENSE-MIT
â”œâ”€ .gitignore
â”œâ”€ .clippy.toml
â”œâ”€ .rustfmt.toml
â”œâ”€ deny.toml                          # (NEW) crate-local override; prefer repo-root cargo-deny but keep local bans if needed
â”œâ”€ configs/
â”‚  â”œâ”€ micronode.toml
â”‚  â”œâ”€ micronode.dev.toml
â”‚  â”œâ”€ micronode.amnesia.off.toml      # (NEW) explicit persistence ON profile for amnesia matrix tests
â”‚  â”œâ”€ micronode.pq.toml
â”‚  â””â”€ micronode.pq.required.toml
â”œâ”€ docs/
â”‚  â”œâ”€ ALL_DOCS.md
â”‚  â”œâ”€ API.md
â”‚  â”œâ”€ CONFIG.md
â”‚  â”œâ”€ CONCURRENCY.md
â”‚  â”œâ”€ GOVERNANCE.md
â”‚  â”œâ”€ INTEROP.md
â”‚  â”œâ”€ PERFORMANCE.md
â”‚  â”œâ”€ QUANTUM.md
â”‚  â”œâ”€ RUNBOOK.md
â”‚  â”œâ”€ SECURITY.md
â”‚  â”œâ”€ IDB.md
â”‚  â”œâ”€ api-history/
â”‚  â”‚  â”œâ”€ micronode.http.json
â”‚  â”‚  â”œâ”€ metrics.scrape.txt
â”‚  â”‚  â””â”€ pq-matrix.json
â”‚  â””â”€ diagrams/
â”‚     â”œâ”€ micronode_arch.mmd
â”‚     â””â”€ micronode_arch.svg
â”œâ”€ specs/                              # (NEW) local protocol/test-vector references for dev & CI
â”‚  â”œâ”€ oap-1.md                         # OAP/1 synopsis (frames, 1 MiB/64 KiB/â‰¤10Ã—, error taxonomy)
â”‚  â”œâ”€ oap_vectors.json                 # canonical good/bad frames (used by fuzz/property tests)
â”‚  â””â”€ pq_handshake_cases.json          # hybrid/required posture cases, downgrade/refusal vectors
â”œâ”€ scripts/
â”‚  â”œâ”€ run_dev.sh
â”‚  â”œâ”€ fs_spy_amnesia.sh
â”‚  â”œâ”€ gen_diagrams.sh
â”‚  â”œâ”€ smoke_oap_limits.sh
â”‚  â”œâ”€ chaos_degrade_shed.sh
â”‚  â””â”€ pq_matrix_ci.sh
â”œâ”€ src/
â”‚  â”œâ”€ main.rs
â”‚  â”œâ”€ lib.rs
â”‚  â”œâ”€ app.rs
â”‚  â”œâ”€ state.rs
â”‚  â”œâ”€ limits.rs
â”‚  â”œâ”€ errors.rs
â”‚  â”œâ”€ types.rs
â”‚  â”œâ”€ cli/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ args.rs
â”‚  â”‚  â””â”€ run.rs
â”‚  â”œâ”€ config/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ schema.rs
â”‚  â”‚  â”œâ”€ load.rs
â”‚  â”‚  â”œâ”€ env_overlay.rs
â”‚  â”‚  â”œâ”€ cli_overlay.rs
â”‚  â”‚  â”œâ”€ validate.rs
â”‚  â”‚  â””â”€ hot_reload.rs
â”‚  â”œâ”€ observability/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ metrics.rs
â”‚  â”‚  â”œâ”€ health.rs
â”‚  â”‚  â”œâ”€ ready.rs
â”‚  â”‚  â”œâ”€ version.rs
â”‚  â”‚  â””â”€ logging.rs
â”‚  â”œâ”€ security/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ auth_macaroon.rs
â”‚  â”‚  â”œâ”€ tls_rustls.rs
â”‚  â”‚  â”œâ”€ amnesia.rs
â”‚  â”‚  â”œâ”€ pq_toggle.rs
â”‚  â”‚  â”œâ”€ pq_config.rs
â”‚  â”‚  â””â”€ pq_observe.rs
â”‚  â”œâ”€ adapters/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ index_client.rs
â”‚  â”‚  â”œâ”€ mailbox_client.rs
â”‚  â”‚  â”œâ”€ storage_client.rs
â”‚  â”‚  â”œâ”€ overlay_client.rs
â”‚  â”‚  â””â”€ policy_client.rs
â”‚  â”œâ”€ facets/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ graph.rs
â”‚  â”‚  â”œâ”€ search.rs
â”‚  â”‚  â”œâ”€ feed.rs
â”‚  â”‚  â””â”€ media.rs
â”‚  â”œâ”€ concurrency/
â”‚  â”‚  â”œâ”€ mod.rs
â”‚  â”‚  â”œâ”€ backpressure.rs
â”‚  â”‚  â”œâ”€ shutdown.rs
â”‚  â”‚  â””â”€ registry.rs
â”‚  â””â”€ http/
â”‚     â”œâ”€ mod.rs
â”‚     â”œâ”€ admin.rs
â”‚     â””â”€ routes.rs
â”œâ”€ tests/
â”‚  â”œâ”€ admin_parity.rs
â”‚  â”œâ”€ amnesia_proof.rs
â”‚  â”œâ”€ oap_limits.rs
â”‚  â”œâ”€ backpressure.rs
â”‚  â”œâ”€ facets_proxy.rs
â”‚  â”œâ”€ pq_modes.rs
â”‚  â””â”€ pq_fallback.rs
â”œâ”€ tests_property/
â”‚  â”œâ”€ oap_fuzz.rs
â”‚  â””â”€ pq_handshake_props.rs
â”œâ”€ tests_chaos/
â”‚  â””â”€ degrade_shed.rs
â”œâ”€ fuzz/
â”‚  â”œâ”€ config_from_env_fuzz.rs
â”‚  â””â”€ pq_kex_fuzz.rs                 # (NEW) fuzz hybrid handshakes (adapter-driven)
â”œâ”€ tests_loom/
â”‚  â””â”€ shutdown_interleavings.rs
â”œâ”€ benches/
â”‚  â”œâ”€ oap_frame_perf.rs
â”‚  â”œâ”€ readiness_walk.rs
â”‚  â””â”€ pq_overhead.rs
â””â”€ examples/
   â””â”€ quickstart.rs
```

---

## ğŸ§­ Roles (tight, file-by-file)

* **deny.toml (NEW)** â€” Local cargo-deny policy (bans/advisories/sources). Prefer a single repo-root `deny.toml`; keep this only if micronode needs stricter per-crate rules.
* **configs/micronode.amnesia.off.toml (NEW)** â€” Persistence-enabled profile to exercise amnesia matrix (OFF/ON) in CI.
* **specs/ (NEW)** â€” Local, versioned protocol vectors for tests:

  * `oap-1.md` â€” OAP/1 behavior & limits summary (1 MiB frame, 64 KiB chunk, â‰¤10Ã— decompress).
  * `oap_vectors.json` â€” Valid/invalid frames for `oap_fuzz.rs` and `oap_limits.rs`.
  * `pq_handshake_cases.json` â€” OFF/HYBRID/REQUIRED handshake paths (success, fallback, refusal).
* **fuzz/pq\_kex\_fuzz.rs (NEW)** â€” Fuzz hybrid KEX paths (e.g., classicalâ†”PQ adapter boundaries) to catch downgrade/timeout edge cases.

Awesomeâ€”hereâ€™s your **Micronode Scaffold Field-Guide**: a tight, â€œwhat/why/how/whenâ€ reference you can glance at while building. No codeâ€”just roles, boundaries, and acceptance checks so the team ships small, clean modules.

---

# ğŸ¯ Build Principles (applies to everything)

* **Tiny files** (<200â€“300 LOC target), single responsibility, unit tests co-located or in `tests/`.
* **No scope creep**: Micronode **proxies** to owner services; it does **not** re-own Graph/Search/Feed/Media.
* **Guardrails everywhere**: amnesia-by-default, OAP caps (1 MiB frame, 64 KiB chunk, â‰¤10Ã— decompress), admin plane parity (`/metrics`, `/healthz`, `/readyz`, `/version`).
* **Concurrency**: bounded queues/semaphores; never hold a lock across `.await`; graceful drain FSM.
* **Quantum (PQ)**: posture = `off|hybrid|required`; adapters live outside; this crate only **toggles & observes**.

---

## Root files

* **Cargo.toml**

  * **Purpose**: Declare bin (`micronode`) and slim features (`graph`, `search`, `feed`, `media`, `pq-hybrid`).
  * **I/O**: Exposes only `lib::run()` + config types.
  * **Gotchas**: Keep feature surfaces additive; pin workspace versions.
  * **Done when**: `cargo check -p micronode` passes for all feature combos.

* **README.md**

  * **Purpose**: Quickstart + invariants + admin endpoints.
  * **Done when**: `examples/quickstart.rs` runs as written.

* **LICENSE-APACHE / LICENSE-MIT**: dual licensing, no changes.

* **.gitignore**: excludes targets, local env, generated diagrams.

* **.clippy.toml / .rustfmt.toml**

  * **Purpose**: Enforce style and safety (e.g., forbid blocking in async).
  * **Done when**: `cargo clippy -- -D warnings` is clean.

* **deny.toml**

  * **Purpose**: Local supply-chain bans/advisories/sources (fallback to repo-root policy).
  * **Done when**: `cargo deny check` is green.

---

## configs/

* **micronode.toml**: Canon defaults for prod (amnesia off unless explicitly enabled; OAP caps; admin binds).
* **micronode.dev.toml**: Dev profile (amnesia on, loopback admin, verbose logs).
* **micronode.amnesia.off.toml**: Persistence-enabled profile to exercise amnesia matrix.
* **micronode.pq.toml**: PQ **hybrid** sample (classicalâ†”PQ allowed; metrics on).
* **micronode.pq.required.toml**: PQ **required** (fail-closed if adapter unavailable).
* **Done when**: `src/config/*` loads+validates; `tests/pq_modes.rs` & `tests/amnesia_proof.rs` pass per profile.

---

## docs/

* **ALL\_DOCS.md; API.md; CONFIG.md; CONCURRENCY.md; GOVERNANCE.md; INTEROP.md; PERFORMANCE.md; QUANTUM.md; RUNBOOK.md; SECURITY.md; IDB.md**

  * **Purpose**: Policy â€œconstitutionâ€ per concern.
  * **Done when**: Each has a corresponding test or CI gate proving the claim (e.g., QUANTUM â†” `pq_*` tests/benches; CONCURRENCY â†” loom test; SECURITY â†” fs-spy & admin loopback).

* **api-history/**

  * `micronode.http.json`: Golden admin surface; used by `tests/admin_parity.rs`.
  * `metrics.scrape.txt`: Golden Prom scrape; names must stay stable.
  * `pq-matrix.json`: Expected behaviors for `pq=off|hybrid|required`.

* **diagrams/**

  * `micronode_arch.mmd/svg`: Mermaid source/render; â€œdocs as codeâ€.

---

## specs/  *(dev/CI test vectors)*

* **oap-1.md**: OAP/1 behaviors (frames, caps, error taxonomy).
* **oap\_vectors.json**: Valid/invalid frames (used by fuzz/property tests).
* **pq\_handshake\_cases.json**: Expected paths for hybrid/required, including refusal/downgrade events.
* **Done when**: Tests consume these vectors (no hard-coded literals in tests).

---

## scripts/

* **run\_dev.sh**: Launch using `micronode.dev.toml`; prints admin URLs.
  **Done when**: Starts, `/readyz` flips true, logs show amnesia=ON.
* **fs\_spy\_amnesia.sh**: Watches filesystem for writes in amnesia mode.
  **Done when**: CI fails if any write escapes RAM-only paths.
* **gen\_diagrams.sh**: Renders Mermaid â†’ SVG (idempotent).
* **smoke\_oap\_limits.sh**: Sends >1 MiB & >10Ã— decompress payloads; expects 413/refusal.
* **chaos\_degrade\_shed.sh**: Fault injection + load to validate 429/Retry-After & readiness transitions.
* **pq\_matrix\_ci.sh**: Executes OFF/HYBRID/REQUIRED test matrix.
  **Note**: All scripts are **safe to run locally** and in CI; no secrets assumed.

---

## src/ (top-level)

* **main.rs**: Parse CLI â†’ `lib::run()`. No heavy logic.
  **Done when**: Covered by `tests/*` via `cargo run` smoke.
* **lib.rs**: Public surface (Config + `run()`); re-exports minimal types.
  **Done when**: No internal wiring leaks into public API.
* **app.rs**: Build `AppState`, wire middleware/routes, apply OAP caps globally.
  **Inputs**: Config, feature flags. **Outputs**: Server handles.
  **Done when**: `/metrics|/healthz|/readyz|/version` live; routes reflect feature gating.
* **state.rs**: `AppState` (config snapshot, metrics registry, semaphores, clients).
  **Rule**: No business logic; no long-held locks.
* **limits.rs**: OAP constants & helpers (1 MiB frame, 64 KiB chunk, â‰¤10Ã— decompress).
  **Used by**: ingress middleware, tests.
* **errors.rs**: Error taxonomy (413/429/503, integrity/limit/busy).
  **Rule**: Stable mapping to HTTP codes.
* **types.rs**: DTOs for admin & simple app surfaces; derive `Serialize/Deserialize`.

---

### src/cli/

* **args.rs**: CLI flags (`--config`, addrs, feature toggles, pq mode); precedence = CLI > ENV > file > defaults.
* **run.rs**: Command dispatch; sets up tracing; calls `app::bootstrap()` and serves.
* **mod.rs**: Re-exports; keep tiny.

**Acceptance**: Changing any flag is reflected in `/version` build/runtime block.

---

### src/config/

* **schema.rs**: Strong types for `limits`, `amnesia`, `tls`, `pq`, per-facet semaphores.
  **Rule**: Defaults here; doc-comment each field.
* **load.rs**: Read file(s), TOML parsing, include-paths safe-list.
* **env\_overlay.rs / cli\_overlay.rs**: Merge overlays with clear precedence.
* **validate.rs**: Enforce OAP caps; reject unknown/forbidden keys (anti-scope).
  **Rule**: Validation is pure & fast; no IO.
* **hot\_reload.rs**: Snapshot-and-swap config (atomic `Arc<Config>`); emits `ConfigUpdated` on bus.
  **Concurrency**: Never hold lock across `.await`.

**Acceptance**: `SIGHUP` (or explicit trigger) flips `/version.config_sha` and `/readyz` remains true.

---

### src/observability/

* **metrics.rs**: Prometheus registry; **golden metrics** (names used in `metrics.scrape.txt`).
* **health.rs**: `/healthz` (internal self-health: process live, basic deps reachable).
* **ready.rs**: `/readyz` (readiness gates, sheds under pressure).
* **version.rs**: `/version` (build info, features, pq posture, amnesia).
* **logging.rs**: JSON logging; structured fields (`pq_mode`, `amnesia`, shed state, limits).

**Acceptance**: `tests/admin_parity.rs` diffs `/version` shape & metric names against snapshots.

---

### src/security/

* **auth\_macaroon.rs**: Capability tokens; least-privilege, short TTL; no ambient admin.
* **tls\_rustls.rs**: TLS plumbed via `tokio_rustls::rustls::ServerConfig`.
* **amnesia.rs**: RAM-only guard, temp-fs abstraction, zeroize on shutdown.
* **pq\_toggle.rs**: Runtime posture enum `{Off, Hybrid, Required}`; single switch used by TLS/auth.
* **pq\_config.rs**: Parse `pq.*` keys, validate, normalize to typed posture; expose to `AppState`.
* **pq\_observe.rs**: Metrics & logs: `pq_mode`, `pq_kex`, `pq_sign`, `pq_fallback_total`, `pq_refused_total`.

**Acceptance**:

* `pq=required` without adapters â†’ start-up **fails closed**; logged & metered.
* `pq=hybrid` with adapter failure â†’ classic fallback allowed; counters increment.

---

### src/adapters/

* **index\_client.rs / mailbox\_client.rs / storage\_client.rs / overlay\_client.rs**

  * **Purpose**: Thin, typed proxies to owner services; bounded concurrency; timeouts; retries per policy.
* **policy\_client.rs**

  * **Purpose**: Read-only calls to policy (residency/geo constraints) to gate facet routes.

**Acceptance**: `tests/facets_proxy.rs` confirms calls leave the process (no local re-ownership) and are bounded.

---

### src/facets/

* **graph.rs / search.rs / feed.rs / media.rs**

  * **Purpose**: Feature-gated HTTP handlers that **proxy** to adapters with per-facet semaphores.
  * **Rule**: No local queue growth beyond configured bounds; return Busy/429 with `Retry-After`.

**Acceptance**: Under synthetic load, `tests/backpressure.rs` shows 429 within budget; no OOM or tail-latency explosion.

---

### src/concurrency/

* **backpressure.rs**: Global & per-facet semaphores; 429/`Retry-After` policy; shed logging.
* **shutdown.rs**: Drain FSM (Runningâ†’Drainingâ†’Stopped), deadlines, cancel tokens.
* **registry.rs**: (Optional) declarative topology for docs/tests (task names, channels).

**Acceptance**: Loom test covers drain interleavings; chaos test shows readiness transitions.

---

### src/http/

* **admin.rs**: `/metrics`, `/healthz`, `/readyz`, `/version` (admin plane parity).
* **routes.rs**: App routes; all ingress wrapped with OAP caps, streaming defaults.

**Acceptance**: `tests/admin_parity.rs` + `metrics.scrape.txt` comparison pass.

---

## tests/ (integration)

* **admin\_parity.rs**: Admin surface & metrics name stability vs snapshots.
* **amnesia\_proof.rs**: Spawn with amnesia; assert **no disk writes**; check zeroize on shutdown.
* **oap\_limits.rs**: >1 MiB & >10Ã— decompress â†’ 413/refusal; chunking at 64 KiB.
* **backpressure.rs**: Load â†’ 429 within 50 ms; no unbounded buffers.
* **facets\_proxy.rs**: Proves out-of-process calls; bounded semaphores.
* **pq\_modes.rs**: OFF/HYBRID/REQUIRED behavior matrix; required must fail closed without adapter.
* **pq\_fallback.rs**: HYBRID: force adapter error â†’ classic fallback + metrics/logs.

**Acceptance**: All pass in CI across matrix `{pq=off,hybrid,required}`.

---

## tests\_property/

* **oap\_fuzz.rs**: Property checks for frames/limits/error taxonomy using `specs/oap_vectors.json`.
* **pq\_handshake\_props.rs**: Idempotence/timeouts/error mapping using `specs/pq_handshake_cases.json`.

---

## tests\_chaos/

* **degrade\_shed.rs**: Fault injection + soak; verifies shed behavior and `/readyz` flips accordingly.

---

## fuzz/

* **config\_from\_env\_fuzz.rs**: Stress env/overlay parser; ensure no panics, consistent precedence.
* **pq\_kex\_fuzz.rs**: Hybrid KEX boundary fuzz; ensures refusal/downgrade mapping is stable.

---

## tests\_loom/

* **shutdown\_interleavings.rs**: Loom test of drain FSM; validates no deadlocks, correct final states.

---

## benches/

* **oap\_frame\_perf.rs**: Encode/decode p95/p99 budget tracking.
* **readiness\_walk.rs**: Shedâ†’ready latencies under step load.
* **pq\_overhead.rs**: PQ OFF vs HYBRID vs REQUIRED overhead; CI gate for acceptable delta.

---

## examples/

* **quickstart.rs**: Minimal run (amnesia ON, loopback admin); mirrors README Quickstart.

---

# âœ… Suggested â€œDefinition of Doneâ€ per concern (quick checklist)

* **SEC**: amnesia proof + admin loopback; PQ required mode fail-closed path covered; macaroon TTL enforced.
* **RES**: backpressure 429 within budget; graceful drain loom test green.
* **PERF**: OAP encode/decode p95 tracked; PQ overhead within threshold (e.g., â‰¤10%).
* **GOV**: admin parity snapshots updated; `deny`/clippy clean.
* **DX**: quickstart runs; diagrams render; examples compile.
* **ECON**: *(N/A for micronodeâ€”no ledger/issuance here; proxies only).*

