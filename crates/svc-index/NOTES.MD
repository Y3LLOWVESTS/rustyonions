### BEGIN NOTE - OCTOBER 29 2025 - 14:41 CST

---

# Carryover Notes for `svc-index` (from `svc-storage`)

**Date:** 2025-10-29 (America/Chicago)
**Context:** `svc-storage` is Beta-complete. `svc-index` should reuse its invariants, error model, and ops patterns to stay cohesive with RON-CORE.

## 1) Canonical invariants to **reuse verbatim**

* **CID format:** `b3:<64-lowercase-hex>` only. Uppercase → malformed.
  Minimal validator (no regex):

  ```rust
  #[inline]
  pub fn is_valid_b3(cid: &str) -> bool {
      cid.len() == 67 && cid.starts_with("b3:") &&
      cid.as_bytes()[3..].iter().all(|&b| matches!(b, b'0'..=b'9'|b'a'..=b'f'))
  }
  ```
* **Strong ETag:** quoted hex, e.g. `"aa…ff"`. When `svc-index` returns object-related metadata, keep ETag quoted.
* **Error split:**

  * `400` → malformed CID (validation fail).
  * `404` → well-formed but unknown (not present in storage / index).
  * `416` (range) is storage-only; index should not emit it unless it proxies byte ranges (not planned).
* **Health plane:** expose `/healthz` (always 200) and `/readyz` (truthful if possible).
* **Metrics plane:** `/metrics` with Prometheus exposition; namespaced counters & histograms.

## 2) Contract between **svc-index ↔ svc-storage**

* **Existence probe:** use `HEAD /o/:cid` from storage as the single source of truth for existence and size (`Content-Length`) and identity (`ETag`).
* **When creating index records:**

  * Validate CID with `is_valid_b3`. If false → `400`.
  * Optionally call storage `HEAD` to confirm presence; if 404 → reject index create with `404` (or `409/FailedPrecondition` if you distinguish).
  * **Idempotency:** indexing the same CID twice should be safe; treat as upsert by default.
* **Optional caching:** you may cache `{cid -> (len, etag, seen_at)}` with a short TTL. Always treat storage as the authority; on 404 from storage, purge cache.

## 3) `svc-index` API sketch (keep parity with storage error model)

* `POST /i` — create/update an index entry (CID + tags/labels/owner/scopes, etc.).

  * Validate CID (400). Optionally verify with storage HEAD; if absent → 404.
  * Return JSON with the normalized record and ETag echo (if you round-trip it).
* `GET /i/:cid` — fetch index metadata for CID (200 or 404).
* `DELETE /i/:cid` — remove index record (204 or 404). (Does **not** delete blob from storage.)
* `GET /i/search?...` — query by tags/owner/time/etc. (200; empty list ok).
* Observability: `/healthz`, `/readyz`, `/metrics`, `/version` (mirror storage).

## 4) Suggested internal boundary (clean testability)

Define a **storage client trait** in `svc-index`, with an HTTP adapter. This keeps tests hermetic and lets you stub storage easily.

```rust
#[async_trait::async_trait]
pub trait StorageProbe: Send + Sync + 'static {
    async fn head(&self, cid: &str) -> Result<StorageMeta, ProbeError>;
}

#[derive(Clone, Debug)]
pub struct StorageMeta { pub len: u64, pub etag: String } // etag must be quoted

#[derive(thiserror::Error, Debug)]
pub enum ProbeError {
    #[error("malformed cid")] Malformed,
    #[error("not found")] NotFound,
    #[error("transport")] Transport(anyhow::Error),
}
```

* **HTTP adapter:** maps `HEAD /o/:cid` → `StorageMeta`.

  * 200 → Ok(meta) (len from `Content-Length`, etag from `ETag`).
  * 400 → `ProbeError::Malformed`.
  * 404 → `ProbeError::NotFound`.
  * Others → `ProbeError::Transport`.

In handlers, translate `ProbeError` to **the same** HTTP status codes used in storage for cohesion.

## 5) Metrics names to keep consistent

* `index_put_total{status}` — for create/update.
* `index_get_total{status}` — for fetch.
* `index_delete_total{status}` — for delete.
* `index_request_latency_seconds{route,method,status}` — histogram with low-lat buckets (reuse storage’s buckets).
* **Storage probe:** `index_storage_head_total{status}`; latency histogram `index_storage_head_seconds`.

## 6) Testing patterns to carry over

* **Black-box integration test** that spawns `svc-index` binary and uses `reqwest` (like storage).
* **Contract tests** for status code mapping: malformed (400), unknown (404), success (200/204).
* **Mock StorageProbe** to simulate storage HEAD outcomes (200/400/404/5xx).
* **Smoke script** mirroring storage style:

  * `POST /i` with a known CID (after pushing a blob to storage) → 200.
  * `GET /i/:cid` → 200 with expected fields.
  * `GET /i/:fake_b3_zeros` → 404.
  * `/metrics` → 200.
  * PASS/FAIL summary; tail logs on fail.

## 7) Operational/behavioral notes

* **Idempotency keys:** If you allow client-supplied dedupe keys for writes, document them. Otherwise, treat `POST /i` as idempotent per CID.
* **Pagination & sorting:** For search endpoints, choose stable defaults and return `next_page` cursors; document limits.
* **Consistency:** `svc-index` is logically **downstream** of storage. If storage returns 404 after an index exists (unlikely for this profile), decide whether to:

  * Keep stale index entries (soft-state), or
  * Periodically reconcile (background janitor: probe a tiny subset daily).
* **Auth:** Same stance as Micronode dev: no auth now; gate later with feature flags (macaroons/tokens).
* **Limits:** Document reasonable caps (tags per record, label sizes, max payload in index create). Reject oversize with 413/400 as appropriate.

## 8) Performance stance (for now)

* Index I/O is light; primary cost is storage HEAD probes and DB writes.
* Add a tiny in-process LRU for HEAD meta (len/etag) with short TTL to reduce hot-path probes if you call storage frequently during search responses.

## 9) Reusable code bits

* **CID validator** (above). Put it in a small `cid.rs` module in `svc-index` to avoid cross-crate coupling for now.
* **HTTP helpers:** error mappers `(StatusCode, Json{err})` or plain status codes, same as storage’s minimalist style.
* **Observability bootstrap:** copy storage’s tracing init and Prometheus exporter gating.

## 10) “Do not drift” checklist

* [ ] 400 vs 404 split identical to storage.
* [ ] ETag always **quoted** when returned.
* [ ] Health/ready/metrics endpoints and behavior aligned.
* [ ] Scripts/tests follow the same PASS/FAIL style.
* [ ] No `axum-extra`, no `http_body_util` (stay with Axum core + `headers`).
* [ ] Keep pins consistent with workspace (tokio, axum 0.7, reqwest rustls, etc.).

---


### END NOTE - OCTOBER 29 2025 - 14:41 CST
