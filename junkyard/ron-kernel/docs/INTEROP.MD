
---

**File:** `crates/ron-kernel/docs/INTEROP.md`

````markdown
# üîó INTEROP.md ‚Äî ron-kernel

*Audience:* developers, auditors, external SDK authors  
*msrv:* 1.80.0  
*concerns:* Microkernel/Interop focus ‚Üí **[SEC, RES, PERF, GOV, DX]**„Äêturn1file0‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L12-L16„Äë

---

## 0) Purpose

Declare the **interop surface** of `ron-kernel`‚Äîwhat the kernel exposes and guarantees‚Äîand what it explicitly does **not** own.

**Kernel scope (Pillar-1):** lifecycle/supervision, config hot-reload, health/readiness wiring, **in-process bus**, and canonical observability hooks; it is **not** overlay/DHT/storage/ledger/gateway logic„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L28-L32„Äë.

**Global deltas reflected here:** canonical 33-crate alignment, Arti under `ron-transport` feature, and **Global Amnesia Mode** surfaced by the kernel for services to honor„Äêturn1file0‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L22-L69„Äë.

Kernel is **crypto/protocol-neutral**: it **exposes** OAP/1 constants and content-addressing rules via metrics/events, but **does not enforce** wire behavior (services do)„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L5-L11„Äë.

---

## 1) Protocols & Endpoints

**Kernel-owned ingress endpoints:** **None.** Services (e.g., gateway/storage/overlay) terminate HTTP/OAP/QUIC. Kernel provides types, supervision, health/ready wiring, and metrics„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L5-L9„Äë.

**Normative protocol facts (observability surfaced by kernel):**
- **OAP/1 framing:** default **`max_frame = 1 MiB`**; **storage streaming chunk = 64 KiB** (not the same thing). Enforcement in services; kernel records rejects/latency„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L5-L10„Äë.
- **Content addressing:** object IDs are **`b3:<hex>`** (BLAKE3-256). Services **MUST verify full digest** before serving bytes; kernel exposes counters/latency only„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L7-L10„Äë.
- **DATA header rule (explicit):** `DATA` frames include `obj:"b3:<hex>"` for object IDs; frames above negotiated `max_frame` rejected **by services**„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L7-L10„Äë.
- **TLS type at boundaries:** any TLS touched by kernel uses `tokio_rustls::rustls::ServerConfig` (never `rustls::ServerConfig`)„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L33-L38„Äë.
- **PQ readiness posture:** kernel remains **crypto-neutral**; **passes through** PQ feature flags (e.g., `pq_hybrid=true`) and surfaces them in health snapshots so ops can verify posture„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L41-L45„Äë„Äêturn1file1‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L7-L11„Äë.

> **Spec policy:** Keep local OAP file as a **stub** pointing to the external normative spec to avoid drift„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L50-L53„Äë.

---

## 2) DTOs / Schemas

### 2.1 Kernel Public API (frozen surface)

The kernel re-exports **exactly** this set (semver-frozen; major bump required for changes)„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L1-L12„Äë„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L25-L26„Äë:

```rust
pub use {
  Bus,
  KernelEvent,
  Metrics,
  HealthState,
  Config,
  wait_for_ctrl_c,
};
````

`KernelEvent` shape (internal enum)„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L15-L24„Äë:

```rust
enum KernelEvent {
  Health        { service: String, ok: bool },
  ConfigUpdated { version: u64 },
  ServiceCrashed{ service: String, reason: String },
  Shutdown,
}
```

### 2.2 Polyglot Audit/Export Shape (JSON)

For cross-language auditors/SDK tooling, kernel events exported to logs/streams MUST serialize as **flat JSON** with variant in `"type"`:

```json
{ "type":"Health",        "service":"svc-storage", "ok":true }
{ "type":"ConfigUpdated", "version":42 }
{ "type":"ServiceCrashed","service":"svc-index","reason":"panic: sled iterator misuse" }
{ "type":"Shutdown" }
```

*Wire DTOs (OAP envelopes, manifests, etc.) live in `ron-proto` with `#[serde(deny_unknown_fields)]` to prevent drift; the kernel does **not** define wire payloads*„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L10-L11„Äë.

---

## 3) Bus Topics

The kernel ships a **monomorphic**, broadcast-backed bus with **bounded** buffers and explicit **lag/drop metrics**„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L33-L39„Äë. Supervisory paths obey ‚Äúno locks across `.await`‚Äù; each task owns its own receiver„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L35-L36„Äë.

### 3.1 Published Topics (canonical, stable)

* `kernel.health` ‚Üí `KernelEvent::Health { service, ok }`
* `kernel.config.updated` ‚Üí `KernelEvent::ConfigUpdated { version }`
* `kernel.service.crashed` ‚Üí `KernelEvent::ServiceCrashed { service, reason }`
* `kernel.shutdown` ‚Üí `KernelEvent::Shutdown`

Overflow **must not block**; bus saturation increments `bus_lagged_total` (and drop counters, if implemented)„Äêturn1file5‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L14-L16„Äë„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L37-L39„Äë.

### 3.2 Subscriptions

Kernel doesn‚Äôt subscribe to app/service topics; services subscribe to kernel lifecycle/config. Readiness gates use **`HealthState` snapshots** to guard `/readyz` in services„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L31-L34„Äë.

---

## 4) Canonical Test Vectors (kernel-focused)

> Location: `crates/ron-kernel/tests/vectors/`

1. **Bus overflow visibility**
   **Setup:** Publish N ‚â´ capacity.
   **Expect:** `bus_lagged_total` (and drop counters where present) increase; no deadlocks; supervisor still emits `ServiceCrashed` on induced panic„Äêturn1file5‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L12-L16„Äë„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L13-L15„Äë.

2. **Readiness degradation**
   **Setup:** Keep a dependent service ‚Äúnot ready‚Äù past deadline.
   **Expect:** `/readyz` (service endpoint) returns **503** with explicit **degraded** semantics; kernel `HealthState` reflects non-ready snapshot„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L31-L34„Äë.

3. **OAP/1 observability (non-enforcing)**
   **Setup:** Service injects frames > 1 MiB.
   **Expect:** Service rejects (400/413 per hardening); kernel counters reflect rejects; kernel never enforces wire rules„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L5-L11„Äë.

4. **Content-address sanity**
   **Setup:** Known payload ‚áí `b3:<hex>`; service GET round-trip.
   **Expect:** Service verifies full digest; kernel exposes latency/error metrics only„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L7-L10„Äë.

> OAP/manifest wire-vectors live with `oap`/`ron-proto`; kernel vectors center on **bus**, **health/readiness**, and **observability**.

---

## 5) Error Taxonomy (kernel-adjacent observability)

Services own the HTTP/OAP **envelope**; kernel standardizes **observability**:

* **400 BadVersion / 413 FrameTooLarge** ‚Üí OAP enforcement in services; kernel increments reject counters only„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L5-L11„Äë.
* **429 QuotaExceeded** ‚Üí ingress quota (service); kernel surfaces reject/latency signals.
* **503 NotReady / Degraded** ‚Üí readiness gate fail-closed (service); kernel‚Äôs `HealthState` drives readiness semantics„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L31-L34„Äë.

---

## 6) Interop Guarantees

* **No Kernel Drift:** Public re-exports + `KernelEvent` shape are **frozen**; breaking changes require **major** version and migration notes„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L25-L26„Äë.
* **SemVer Discipline:** Wire DTOs in `ron-proto` have schema-compat tests with `deny_unknown_fields` (kernel never mirrors them)„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L10-L11„Äë.
* **Backward Compatibility (polyglot logs):** Unknown JSON fields in **exported audit** lines are ignored by consumers; field names are stable.
* **Auditability:** Canonical kernel vectors (overflow, degraded readiness) live under `/tests/vectors/`; OAP wire vectors live with `oap`.

---

## 7) References

* **Microkernel Blueprint (FINAL+)** ‚Äî scope, frozen API, OAP/constants, amnesia label„Äêturn1file0‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L28-L41„Äë„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L33-L40„Äë
* **Protocol & Addressing (Pillar-1)** ‚Äî 1 MiB frame; 64 KiB storage chunk; `b3:<hex>`; DATA header rule„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L5-L10„Äë
* **Integrations Non-Goals** ‚Äî transport/overlay/DHT owned by services; kernel doesn‚Äôt run I/O loops„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L5-L11„Äë
* **Security & PQ Readiness** ‚Äî PQ flag pass-through; crypto-neutral kernel posture„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L37-L45„Äë
* **Verification Plan** ‚Äî loom/fuzz/TLA+, perf harness; CI label routing„Äêturn1file1‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L33-L41„Äë„Äêturn1file5‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L1-L9„Äë

---

## 8) Bus Flow (visual, not normative)

```mermaid
flowchart LR
  subgraph Kernel
    K[supervisor] -->|emit| B(broadcast bus)
    C[config watcher] -->|ConfigUpdated| B
    H[health/readiness] -->|Health| B
  end

  B -->|ServiceCrashed| Ops[operators/alerts]
  B --> SvcA[svc-gateway]
  B --> SvcB[svc-storage]
  B --> SvcC[svc-overlay]

  note right of Ops: watch restarts & bus lag metrics
```

*Bounded buffers; lag/drop metrics; no locks across `.await` on supervisory paths„Äêturn1file4‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L33-L36„Äë.*

---

## 9) Amnesia & PQ in Interop

* **Amnesia Mode (kernel flag):** surfaced as a read-only snapshot and as metrics label `amnesia="on|off"`; services must interpret as RAM-only caches, ephemeral logs, aggressive zeroization„Äêturn1file2‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L53-L60„Äë„Äêturn1file0‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L68-L69„Äë.
* **PQ Flags (pass-through):** kernel must not block PQ adoption; **passes through** transport/proto flags untouched and surfaces posture in health snapshots„Äêturn1file1‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L7-L11„Äë.

---

## 10) Verification Hooks (CI Teeth)

* **Hermetic tests**: bus/topic/load (no network)„Äêturn1file6‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L49-L52„Äë
* **Loom/Fuzz (RES)** where applicable; **TLA+ specs** for supervisor/bus (`specs/supervisor.tla`, `specs/bus.tla`)„Äêturn1file1‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L33-L36„Äë
* **Perf harness** in `testing/performance` (publish rates vs lag; frame rate vs ACK credit)„Äêturn1file1‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L35-L37„Äë
* **CI label routing**: kernel/bus/ryker PRs trigger RES jobs + GOV checks„Äêturn1file5‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L6-L9„Äë

---

## 11) Acceptance Gates (Definition of Done)

* [ ] **API surface frozen:** re-exports + `KernelEvent{..reason}` unchanged„Äêturn1file3‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L7-L13„Äë
* [ ] **Concurrency:** no locks across `.await`; all channels **bounded**„Äêturn1file3‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L8-L8„Äë
* [ ] **Metrics present:** `bus_lagged_total`, `service_restarts_total`, `request_latency_seconds` validated by tests„Äêturn1file3‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L9-L10„Äë
* [ ] **Readiness:** `/readyz` degrades/fails under saturation or restart storms (service-side)„Äêturn1file3‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L10-L10„Äë
* [ ] **TLS type invariant:** `tokio_rustls::rustls::ServerConfig` only„Äêturn1file3‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L11-L11„Äë
* [ ] **Amnesia:** kernel flag surfaced; metrics labeled `amnesia`„Äêturn1file3‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L12-L12„Äë
* [ ] **OAP/1 rule:** `DATA` header includes `obj:"b3:<hex>"`; no conflation of frame vs chunk sizes„Äêturn1file3‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L13-L13„Äë
* [ ] **Formal/Perf hooks:** TLA+ specs exist; perf harness smoke passes„Äêturn1file3‚Ä†MICROKERNEL_BLUEPRINT.MD‚Ä†L14-L14„Äë

---

```

